<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>web-palette-tui</title>
<style>
/* --- Terminal-style minimal CSS --- */
:root{--bg:#0b0b0c;--fg:#d7d7d7;--dim:#6a6a6a;--acc:#43a047}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);font:12px/1.2 ui-monospace,Consolas,Menlo,monospace;display:flex;flex-direction:column}
.header,.status,.cmd{padding:6px 8px;border-bottom:1px solid #222}
.header{display:flex;gap:12px;align-items:center}
.header .title{color:var(--acc);font-weight:700}
.header .hint{color:var(--dim)}
.grid{flex:1;display:grid;grid-template-columns:repeat(4,1fr);gap:2px;padding:2px;background:#111;outline:none}
.cell{position:relative;min-height:54px;border:1px solid #000}
.cell.sel{outline:2px solid #fff7;box-shadow:0 0 0 2px #fff2 inset}
.overlay{position:absolute;bottom:2px;left:4px;right:4px;font-weight:700;font-size:10px;padding:1px 2px}
.overlay input{width:100%;border:none;background:transparent;font:inherit;font-weight:700;outline:none}
.status{display:flex;gap:16px;align-items:center;border-top:1px solid #222;border-bottom:none}
.status .kv{color:var(--dim)}
.status .val{color:var(--fg)}
.status .fmt{color:var(--acc)}
.cmd{display:none;border-top:1px solid #222}
.cmd.active{display:block}
input.cmdline{width:100%;padding:6px 8px;color:var(--fg);background:#0f0f11;border:1px solid #222;outline:none}
</style>
<body>
<div class="header">
  <div class="title">web-palette-tui</div>
  <div class="hint">
    hjkl move • H/L hue • S/D sat • V/F light • Shift+Alt = ×10 step • y copy • p paste • u undo • Ctrl-r redo • : command • e edit hex
  </div>
  <div class="hint">format:<span id="fmt" class="fmt">hex</span></div>
</div>
<div id="grid" class="grid" tabindex="0"></div>
<div class="status" id="status"></div>
<div class="cmd" id="cmd"><input id="cmdline" class="cmdline" spellcheck="false" autocomplete="off" /></div>
<script>
/* --- Utility --- */
const clamp=(x,a,b)=>x<a?a:x>b?b:x, mod=(n,m)=>(n%m+m)%m;
const pad2=x=>x.length==1?"0"+x:x, hex2=n=>pad2(Math.round(clamp(n,0,255)).toString(16));
const rgbStr=(r,g,b)=>`rgb(${Math.round(r)},${Math.round(g)},${Math.round(b)})`;
const hexStr=(r,g,b)=>"#"+hex2(r)+hex2(g)+hex2(b);

/* --- Color Math (HSL) --- */
function hsl2rgb(h,s,l){
  h=mod(h,360); s=clamp(s,0,1); l=clamp(l,0,1);
  const c=(1-Math.abs(2*l-1))*s;
  const x=c*(1-Math.abs(((h/60)%2)-1));
  const m=l-c/2;
  let r=0,g=0,b=0;
  if(h<60){r=c;g=x}
  else if(h<120){r=x;g=c}
  else if(h<180){g=c;b=x}
  else if(h<240){g=x;b=c}
  else if(h<300){r=x;b=c}
  else{r=c;b=x}
  return [(r+m)*255,(g+m)*255,(b+m)*255];
}
function rgb2hsl(r,g,b){
  r/=255;g/=255;b/=255;
  const mx=Math.max(r,g,b), mn=Math.min(r,g,b), d=mx-mn;
  let h=0; if(d){ if(mx===r) h=60*mod((g-b)/d,6); else if(mx===g) h=60*((b-r)/d+2); else h=60*((r-g)/d+4); }
  const l=(mx+mn)/2;
  const s=d===0?0:d/(1-Math.abs(2*l-1));
  return [mod(h,360), s, l];
}
function parseHex(s){
  if(!s) return null;
  s=s.trim().toLowerCase().replace(/^#/,"");
  if(!/^[0-9a-f]{6}$/.test(s)) return null;
  return [parseInt(s.slice(0,2),16), parseInt(s.slice(2,4),16), parseInt(s.slice(4,6),16)];
}

/* --- State --- */
const W=4,H=4,N=W*H;
let cells=Array.from({length:N},(_,i)=>({h:(i*360/N)|0,s:0.6,l:0.5}));
let idx=0, fmt="hex", clip=null, hist=[], redo=[], editingHex=false, cmdMode=false;

/* --- Persistence --- */
function save(){
  try{
    const data={c:cells.map(o=>[+o.h.toFixed(1),+o.s.toFixed(3),+o.l.toFixed(3)]),i:idx,f:fmt};
    const s=JSON.stringify(data);
    localStorage.setItem("wptui",s);
    location.hash=btoa(unescape(encodeURIComponent(s)));
  }catch{}
}
function load(){
  try{
    let s=null;
    if(location.hash.length>1) try{s=decodeURIComponent(escape(atob(location.hash.slice(1))))}catch{}
    if(!s) s=localStorage.getItem("wptui");
    if(!s) return;
    const d=JSON.parse(s);
    if(Array.isArray(d.c)&&d.c.length===N){
      cells=d.c.map(a=>({h:a[0],s:a[1],l:a[2]}));
      idx=clamp(d.i|0,0,N-1); fmt=(["rgb","hsl"].includes(d.f)?d.f:"hex");
    }
  }catch{}
}

/* --- History --- */
const snap=()=>JSON.stringify(cells);
const pushHist=()=>{hist.push(snap()); if(hist.length>100) hist.shift(); redo.length=0};
const doUndo=()=>{if(hist.length){redo.push(snap()); cells=JSON.parse(hist.pop()); render()}};
const doRedo=()=>{if(redo.length){hist.push(snap()); cells=JSON.parse(redo.pop()); render()}};

/* --- UI Rendering --- */
const grid=document.getElementById("grid"), status=document.getElementById("status"), fmtEl=document.getElementById("fmt");
function buildGrid(){
  grid.innerHTML="";
  for(let i=0;i<N;i++){
    const d=document.createElement("div");
    d.className="cell"; d.addEventListener("click",()=>{idx=i; renderSel()});
    grid.appendChild(d);
  }
}
function fmtColor(o){
  const [r,g,b]=hsl2rgb(o.h,o.s,o.l);
  if(fmt==="rgb") return `rgb(${Math.round(r)},${Math.round(g)},${Math.round(b)})`;
  if(fmt==="hsl") return `hsl(${o.h.toFixed(0)},${Math.round(o.s*100)}%,${Math.round(o.l*100)}%)`;
  return hexStr(r,g,b);
}
function render(){
  for(let i=0;i<N;i++){
    const c=cells[i], [r,g,b]=hsl2rgb(c.h,c.s,c.l), el=grid.children[i];
    el.style.background=rgbStr(r,g,b);
    let ov=el.querySelector(".overlay");
    if(!ov){ov=document.createElement("div");ov.className="overlay";el.appendChild(ov)}
    if(!(editingHex && i===idx)) ov.textContent=fmtColor(c);
    ov.style.color = (0.2126*(r/255)+0.7152*(g/255)+0.0722*(b/255))>0.6 ? "#000" : "#fff";
  }
  renderSel(); renderStatus(); fmtEl.textContent=fmt; save();
  if(!editingHex && document.activeElement!==grid) grid.focus();
}
function renderSel(){[...grid.children].forEach((el,i)=>el.classList.toggle("sel",i===idx))}
function renderStatus(){
  const c=cells[idx], [r,g,b]=hsl2rgb(c.h,c.s,c.l);
  status.innerHTML=`<span class="kv">idx</span> <span class="val">${idx+1}/${N}</span>
  <span class="kv">HSL</span> <span class="val">${c.h.toFixed(1)},${Math.round(c.s*100)}%,${Math.round(c.l*100)}%</span>
  <span class="kv">RGB</span> <span class="val">${Math.round(r)},${Math.round(g)},${Math.round(b)}</span>
  <span class="kv">HEX</span> <span class="val">${hexStr(r,g,b)}</span>
  <span class="kv">fmt</span> <span class="fmt">${fmt}</span>`;
}

/* --- Editing --- */
function setHexOnIndex(i,hex){
  const rgb=parseHex(hex); if(!rgb) return false;
  const [h,s,l]=rgb2hsl(...rgb); cells[i]={h,s,l}; return true;
}
function startHexEdit(){
  if(fmt!=="hex"||editingHex) return;
  const el=grid.children[idx], ov=el.querySelector(".overlay");
  const [r,g,b]=hsl2rgb(cells[idx].h,cells[idx].s,cells[idx].l), hex=hexStr(r,g,b);
  ov.textContent=""; const inp=document.createElement("input");
  Object.assign(inp,{type:"text",value:hex,spellcheck:false,autocomplete:"off"});
  ov.appendChild(inp); editingHex=true; inp.focus(); inp.setSelectionRange(1,hex.length);
  inp.onkeydown=e=>{
    if(e.key==="Enter"){if(setHexOnIndex(idx,inp.value)){pushHist(); render()} stopEdit()}
    else if(e.key==="Escape"){stopEdit()}
  };
  function stopEdit(){editingHex=false; render()}
}

/* --- Actions --- */
const move=(dx,dy)=>{const x=idx%W,y=(idx/W)|0; idx=clamp(x+dx,0,W-1)+clamp(y+dy,0,H-1)*W; renderSel(); renderStatus(); save()};
const adjHue=d=>{pushHist(); cells[idx].h=mod(cells[idx].h+d,360); render()};
const adjSat=d=>{pushHist(); cells[idx].s=clamp(cells[idx].s+d,0,1); render()};
const adjLight=d=>{pushHist(); cells[idx].l=clamp(cells[idx].l+d,0,1); render()};
const cycleFmt=()=>{fmt=fmt==="hex"?"rgb":fmt==="rgb"?"hsl":"hex"; render()};
const yank=()=>{clip={...cells[idx]}; navigator.clipboard.writeText(fmtColor(cells[idx])).catch(()=>{})};
const paste=()=>{if(clip){pushHist(); cells[idx]={...clip}; render()}};

/* --- Commands --- */
function runCmd(s){
  const [c,arg]=s.trim().split(/\s+/);
  if(c==="format"&&["hex","rgb","hsl"].includes(arg)){fmt=arg; render()}
  else if(c==="copy"){const old=fmt; if(["hex","rgb","hsl"].includes(arg)) fmt=arg; yank(); fmt=old}
  else if(c==="sethex"&&arg){if(setHexOnIndex(idx,arg)){pushHist(); render()} else alert("Invalid hex")}
  else if(c==="save") save();
  else if(c==="load"){load(); render()}
else if(c==="help") alert(
  "keys: hjkl move • H/L hue • S/D sat • V/F light • Shift+Alt = ×10 step\n" +
  "y copy • p paste • u undo • Ctrl-r redo • : command • e edit hex\n" +
  "commands: :format hex|rgb|hsl • :copy [fmt] • :sethex #rrggbb • :save • :load"
);
}

/* --- Keyboard --- */
grid.onkeydown = e => {
  if (cmdMode) return;
  const k = e.key;
  const big = e.shiftKey && e.altKey; // detect Shift+Alt
  if (e.ctrlKey && !e.shiftKey && k.toLowerCase() === "r")
    return e.preventDefault(), doRedo();
  if (k === ":")
    return e.preventDefault(), cmdMode = true, cmd.classList.add("active"),
      cmdline.value = ":", cmdline.focus();
  if (k === "e") return e.preventDefault(), startHexEdit();

  if (k === "h") move(-1, 0);
  else if (k === "l") move(1, 0);
  else if (k === "k") move(0, -1);
  else if (k === "j") move(0, 1);

  else if (k === "H") adjHue(big ? -10 : -1);
  else if (k === "L") adjHue(big ? 10 : 1);

  else if (k === "S") adjSat(big ? -0.10 : -0.01);
  else if (k === "D") adjSat(big ? 0.10 : 0.01);

  else if (k === "V") adjLight(big ? -0.10 : -0.01);
  else if (k === "F") adjLight(big ? 0.10 : 0.01);

  else if (k === "m") cycleFmt();
  else if (k === "y") yank();
  else if (k === "p") paste();
  else if (k === "u") doUndo();
};
cmdline.onkeydown=e=>{
  if(e.key==="Escape") return cmdMode=false,cmd.classList.remove("active"),grid.focus();
  if(e.key==="Enter"){if(cmdline.value.startsWith(":")) runCmd(cmdline.value.slice(1)); cmdMode=false; cmd.classList.remove("active"); grid.focus();}
};

/* --- Init --- */
load(); buildGrid(); render(); grid.focus();
</script>
</body>
</html>